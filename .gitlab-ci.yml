stages:
  - test
  - upload

test:
  image: python:3.8-alpine
  stage: test

  script:
    - apk add postgresql-dev alpine-sdk
    - git submodule init
    - git submodule update
    - pip install -r requirements.txt
    - pip install -r gnmvidispine/requirements.txt
    - cd gnmvidispine && CIRCLE_BUILD_NUM=$CI_PIPELINE_IID python ./setup.py install && cd ..
    - python ./manage.py test gnm_deliverables.tests

upload:
  image: "docker:19.03.11"
  stage: upload
  services:
    - docker:dind

  script:
    - apk add git
    - git submodule init
    - git submodule update
    - docker build . -t guardianmultimedia/pluto-deliverables:$CI_PIPELINE_IID
    - docker login -u "${DOCKER_USER}" -p "${DOCKER_PAT}"
    - docker push guardianmultimedia/pluto-deliverables:$CI_PIPELINE_IID
